# Data Model: Driving Batch Generators

**Date**: 2025-11-08  
**Spec**: ./spec.md  
**Research**: ./research.md

## Entities

### Company
| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| company_id | STRING | Unique, non-empty | Generated UUID or sequential ID (decide in implementation) |
| geography | STRING | Literal `US` | Single-geo initial iteration |
| active | BOOLEAN | Always true initial iteration | Deactivation deferred |
| created_at | TIMESTAMP | Not null | Generation time |

### DriverEventRecord
| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| event_id | STRING | Unique | Could be UUID; deterministic with seed optional |
| driver_id | STRING | Non-empty | Derived from (company_id + sequence) |
| company_id | STRING | FK -> Company.company_id | Must exist before interval_start |
| truck_id | STRING | Non-empty | Simple synthetic pattern (e.g., TRK-<seed>-<n>) |
| event_type | STRING | Enum: start driving | stopped driving | delivered | Must match allowed set |
| timestamp | TIMESTAMP | UTC, >= interval_start, < interval_end | Interval boundary rule |

### DriverEventBatch
| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| batch_id | STRING | Unique | Derive from interval_start (e.g., ISO compact) |
| interval_start | TIMESTAMP | Not null | 15-min aligned (minute%15==0) |
| interval_end | TIMESTAMP | Not null | = interval_start + 15 minutes |
| event_count | INT | >=0 | Zero allowed for empty interval |
| seed | INT | Not null | Generation reproducibility |
| generation_time | TIMESTAMP | Not null | Actual wall clock time |

### BatchManifest
| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| manifest_id | STRING | Single row id | e.g., 'current' |
| last_batch_id | STRING | FK -> DriverEventBatch.batch_id | Updated each interval |
| total_events | BIGINT | >=0 | Accumulates |
| last_updated | TIMESTAMP | Not null | Updated on each batch generation |

### Config
| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| number_of_companies | INT | >0 | Default 100 |
| drivers_per_company | INT | >0 | Default 10 |
| event_rate_per_driver | FLOAT | >0 | Expected events per 15-min interval |
| company_onboarding_interval | STRING | ISO8601 duration (e.g., PT1H) | Hourly initial default |
| seed | INT | Optional | Autogenerated if absent |

## Relationships
- Company 1..N DriverEventRecord
- DriverEventBatch 1..N DriverEventRecord (by batch interval)
- BatchManifest 1..1 DriverEventBatch (last generated)

## Validation Rules
- Duplicate company_id: reject generation cycle.
- DriverEventRecord company_id must exist in Company before interval_start.
- event_type outside enumeration: discard & log reason.
- Interval timestamps: align to 15-min multiples (minute%15==0 for start; end derived).
- Batch event_count equals number of DriverEventRecord rows stored for that batch.

## State Transitions (Simplified)
- Company: created -> active (no other states initial iteration)
- DriverEventRecord: generated -> persisted (no updates)
- DriverEventBatch: created (all events aggregated) -> persisted -> referenced in manifest

## Schema Evolution Considerations
- Add multi-geo: geography becomes enum set -> requires dataset manifest version bump.
- Add deactivation: active boolean toggle + deactivated_at column.

## Storage Mapping
- raw/: generator outputs (JSON Lines / Delta initial tables for companies and events)
- staged/: Spark job refined tables (e.g., partitioned by date/hour)
- processed/: Aggregated analytic tables (optional future)
- manifests/: BatchManifest + dataset descriptors (dataset.md, seeds)

## Randomness Distribution Model (Option B: Weighted Static + Poisson)

### Inter-Arrival Process
- **Model**: Poisson process with lambda (λ) computed from `event_rate_per_driver` per 15-minute interval.
- **Implementation**: For each driver in a batch, generate event count ~ Poisson(λ); timestamps uniformly distributed within [interval_start, interval_end).
- **Reproducibility**: Seeded random number generator (numpy/random with recorded seed).

### Categorical Attribute Weights (Static)
| Attribute | Category | Weight | Notes |
|-----------|----------|--------|-------|
| event_type | start driving | 0.40 | Most common transition |
| event_type | stopped driving | 0.35 | |
| event_type | delivered | 0.25 | Less frequent completed delivery |
| active | true | 1.00 | All companies initially active (deactivation deferred) |
| geography | US | 1.00 | Single-geo initial iteration |

*Weights sum to 1.0 per attribute; multinomial sampling from weighted distribution ensures realistic skew. Configuration may optionally override default weights in future iterations.*

### Variance Expectations
- Mean event count per batch: `number_of_companies * drivers_per_company * event_rate_per_driver`.
- Standard deviation (Poisson): sqrt(mean).
- Acceptance: 10% deviation tolerance over 10-batch rolling window (SC-012).

## Open Items
- Company ID generation strategy (UUID vs sequential) – choose UUID for uniqueness simplicity.

## Compliance
All entity fields & validation rules map to functional requirements FR-001..FR-016; reproducibility seed recorded per batch.
